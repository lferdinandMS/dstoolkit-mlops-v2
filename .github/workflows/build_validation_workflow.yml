name: Build Validation Workflow

on:
  workflow_call:
    inputs:
      image_name:
        type: string
        description: "Execution Environment"
        required: false
      model_type:
        type: string
        description: "type of model to execute"
        required: false
      is_docker:
        type: boolean
        description: "Is Docker used for build validation?"
        required: false
        default: false

env:
  PYTHON_VERSION: "3.10"

jobs:
  run-unit-tests-docker:
    if: ${{ inputs.is_docker }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          clean: true
          submodules: false


      - name: Show commit and branch
        run: |
          echo "GITHUB_SHA=$GITHUB_SHA"
          git rev-parse HEAD
          git --no-pager log -1 --oneline --decorate


      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Load Python Dependencies
        shell: bash
        run: |
          set -e
          python -m pip install --upgrade pip
          python -m pip install --upgrade \
            -r .github/requirements/build_validation_requirements.txt \
            --extra-index-url https://azuremlsdktestpypi.azureedge.net/sdk-cli-v2/azureml-mlflow/ \
            --trusted-host azuremlsdktestpypi.azureedge.net

      - name: Show Package Versions
        shell: bash
        run: |
          python -m pip show mlflow-skinny azureml-mlflow || true
          python -c "import importlib.metadata as m; print('mlflow-skinny:', m.version('mlflow-skinny'))" || true
          python -c "import importlib.metadata as m; print('azureml-mlflow:', m.version('azureml-mlflow'))" || true

      - name: Lint Code
        run: flake8

      - name: Free up disk space
        shell: bash
        run: |
          echo "Available disk space before cleanup:"
          df -h
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          sudo docker system prune -af
          echo "Available disk space after cleanup:"
          df -h

      - name: Build Docker container
        shell: bash
        run: |
          echo "Building Docker container for validation with tag: ${{ inputs.image_name }}"
          docker build -t ${{ inputs.image_name }} -f mlops/${{ inputs.model_type }}/environment/Dockerfile mlops/${{ inputs.model_type }}/environment

      - name: Run tests in Docker container
        shell: bash
        run: |
          echo "Running Docker container for validation"
          docker run --rm --mount type=bind,src=.,dst=/workspace ${{ inputs.image_name }} /bin/bash -c "
            sudo chown -R vscode /workspace &&
            python -m pip install --upgrade pip &&
            pip install -r .github/requirements/build_validation_requirements.txt \
              --extra-index-url https://azuremlsdktestpypi.azureedge.net/sdk-cli-v2/azureml-mlflow/ \
              --trusted-host azuremlsdktestpypi.azureedge.net &&
            python -m pytest --junitxml=junit/test-results.xml --cov=. --cov-report=xml
          "

      - name: Publish Test Results
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: "**/test-*.xml"

  run-unit-tests:
    if: ${{ !inputs.is_docker }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.sha }}

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Load Python Dependencies
        shell: bash
        run: |
          set -e
          python -m pip install --upgrade pip
          python -m pip install --upgrade --no-cache-dir \
            -r .github/requirements/build_validation_requirements.txt

      - name: Show Package Versions
        shell: bash
        run: |
          python -m pip show mlflow-skinny azureml-mlflow || true
          python -c "import importlib.metadata as m; print('mlflow-skinny:', m.version('mlflow-skinny'))" || true
          python -c "import importlib.metadata as m; print('azureml-mlflow:', m.version('azureml-mlflow'))" || true

      - name: Preview updated smoke script
        shell: bash
        run: |
          git rev-parse HEAD
          git --no-pager log -1 --oneline --decorate
          sed -n '1,120p' scripts/mlflow_compat_smoke.py || true

      - name: Lint Code
        run: flake8
      - name: Run Unit Tests
        shell: bash
        run: |
          pytest --junitxml=junit/test-results.xml --cov=. --cov-report=xml
      - name: Publish Test Results
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: "**/test-*.xml"