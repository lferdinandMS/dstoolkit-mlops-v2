name: MLflow/AzureML-MLflow Compatibility Smoke

on:
  # Manual run from Actions UI
  workflow_dispatch:
    inputs:
      mlflow_version:
        description: "MLflow version (skinny) to test"
        required: false
        default: "2.14.3"
      azureml_mlflow_versions:
        description: "Comma-separated azureml-mlflow versions to test"
        required: false
        default: "1.58.0,1.60.0,1.61.0"
  # Also run when this workflow or the smoke script changes on any branch,
  # so it appears in Actions even before merging to default branch.
  push:
    paths:
      - ".github/workflows/mlflow_compat_smoke.yml"
      - "scripts/mlflow_compat_smoke.py"
  pull_request:
    paths:
      - ".github/workflows/mlflow_compat_smoke.yml"
      - "scripts/mlflow_compat_smoke.py"

jobs:
  smoke-matrix:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        azureml_mlflow:
          - 1.58.0
          - 1.60.0
          - 1.61.0
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies for ${{ matrix.azureml_mlflow }}
        run: |
          python -m pip install --upgrade pip
          echo "Available azureml-mlflow versions on index:"
          python - << 'PY'
          import json, subprocess
          try:
            out = subprocess.check_output(["python","-m","pip","index","versions","azureml-mlflow"], text=True)
            print(out)
          except Exception as e:
            print("pip index failed:", e)
          PY
          pip install "mlflow-skinny==${{ github.event.inputs.mlflow_version || '2.14.3' }}"
          pip install "azureml-mlflow==${{ matrix.azureml_mlflow }}"

      - name: Run smoke test and capture result
        id: smoke
        run: |
          set +e
          python scripts/mlflow_compat_smoke.py
          CODE=$?
          set -e
          echo "code=$CODE" >> $GITHUB_OUTPUT
          echo "{\"azureml_mlflow\":\"${{ matrix.azureml_mlflow }}\",\"mlflow_skinny\":\"${{ github.event.inputs.mlflow_version || '2.14.3' }}\",\"code\":$CODE}" > result.json

      - name: Upload result artifact
        uses: actions/upload-artifact@v4
        with:
          name: smoke-${{ matrix.azureml_mlflow }}
          path: result.json

  choose-winner:
    runs-on: ubuntu-latest
    needs: smoke-matrix
    if: always()
    steps:
      - name: Download all results
        uses: actions/download-artifact@v4
        with:
          pattern: smoke-*
          merge-multiple: true

      - name: Determine winning version
        id: winner
        run: |
          python - << 'PY'
          import json, glob, sys
          from packaging.version import Version

          results = []
          for path in glob.glob('**/result.json', recursive=True):
              try:
                  with open(path, 'r', encoding='utf-8') as f:
                      data = json.load(f)
                  results.append(data)
              except Exception as e:
                  print(f"Failed to read {path}: {e}")

          if not results:
              print("No result.json files found")
              sys.exit(1)

          # code==0 means fully passing (no azureml constructor error and local listing OK)
          passing = [r for r in results if int(r.get('code', 1)) == 0]
          results_sorted = sorted(results, key=lambda r: Version(str(r['azureml_mlflow'])))
          print("All results:")
          for r in results_sorted:
              print(r)

          if not passing:
              print("No passing combinations found (code==0). Failing.")
              sys.exit(1)

          # Choose highest azureml-mlflow among passing
          winner = sorted(passing, key=lambda r: Version(str(r['azureml_mlflow'])))[-1]
          print("Winner:", winner)
          print(f"winner={winner['azureml_mlflow']}")
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"winner={winner['azureml_mlflow']}\n")
          PY

      - name: Summary
        run: |
          echo "Chosen azureml-mlflow version: ${{ steps.winner.outputs.winner }}" >> $GITHUB_STEP_SUMMARY
          echo "\nSee individual smoke-* artifacts for detailed results." >> $GITHUB_STEP_SUMMARY
