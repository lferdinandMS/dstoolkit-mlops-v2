name: MLflow/AzureML-MLflow Compatibility Smoke

on:
  # Manual run from Actions UI
  workflow_dispatch:
    inputs:
      mlflow_version:
        description: "MLflow version (skinny) to test"
        required: false
        default: "2.14.3"
      azureml_mlflow_versions:
        description: "Comma-separated azureml-mlflow versions to test"
        required: false
        default: "1.58.0,1.60.0,1.61.0"
  # Also run when this workflow or the smoke script changes on any branch,
  # so it appears in Actions even before merging to default branch.
  push:
    paths:
      - ".github/workflows/mlflow_compat_smoke.yml"
      - "scripts/mlflow_compat_smoke.py"
  pull_request:
    paths:
      - ".github/workflows/mlflow_compat_smoke.yml"
      - "scripts/mlflow_compat_smoke.py"

jobs:
  smoke-matrix:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        azureml_mlflow:
          - 1.58.0
          - 1.60.0
          - 1.61.0
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies for ${{ matrix.azureml_mlflow }}
        run: |
          python -m pip install --upgrade pip
          echo "Available azureml-mlflow versions on index:"
          python - << 'PY'
          import json, subprocess
          try:
            out = subprocess.check_output(["python","-m","pip","index","versions","azureml-mlflow"], text=True)
            print(out)
          except Exception as e:
            print("pip index failed:", e)
          PY
          pip install "mlflow-skinny==${{ github.event.inputs.mlflow_version || '2.14.3' }}"
          pip install "azureml-mlflow==${{ matrix.azureml_mlflow }}"

      - name: Run smoke test
        run: |
          python scripts/mlflow_compat_smoke.py

  choose-winner:
    runs-on: ubuntu-latest
    needs: smoke-matrix
    if: always()
    steps:
      - name: Determine winning version
        id: winner
        run: |
          # Pick the latest version that passed; GitHub does not expose matrix pass list directly,
          # so we infer based on job result: if the matrix job overall succeeded, prefer the highest.
          # Otherwise, fall back to the lowest in the set. This is a heuristic â€“ refine if needed.
          set -e
          # Default ordered list must match the matrix order
          VERSIONS=(1.58.0 1.60.0 1.61.0)
          if [ "${{ needs.smoke-matrix.result }}" = "success" ]; then
            # prefer the last (highest) as winner
            WINNER=${VERSIONS[-1]}
          else
            # if some failed, pick the first (lowest) as conservative default
            WINNER=${VERSIONS[0]}
          fi
          echo "winner=$WINNER" >> $GITHUB_OUTPUT

      - name: Summary
        run: |
          echo "Chosen azureml-mlflow version: ${{ steps.winner.outputs.winner }}" >> $GITHUB_STEP_SUMMARY
